# AI Orchestration Template - CI/CD Pipeline
# Runs tests, linting, and validation on push and PR

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Validate documentation and configuration
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking required documentation files..."
          files=(
            "README.md"
            "CLAUDE.md"
            "SETUP_CHECKLIST.md"
            "LLM_Orchestrator_Instructions.md"
            "env_template.sh"
          )
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing required file: $file"
              exit 1
            fi
            echo "OK: $file exists"
          done

      - name: Validate env_template has no real keys
        run: |
          echo "Checking env_template.sh for leaked keys..."
          # Check for patterns that look like real API keys (exclude placeholder patterns)
          if grep -E '(sk-[a-zA-Z0-9]{20,}|AIza[a-zA-Z0-9]{35})' env_template.sh | grep -v 'your-\|placeholder\|example'; then
            echo "ERROR: Possible API key found in env_template.sh"
            exit 1
          fi
          # Check for Slack tokens but exclude obvious placeholders
          if grep -E 'xox[baprs]-[a-zA-Z0-9-]{10,}' env_template.sh | grep -v 'your-slack\|placeholder'; then
            echo "ERROR: Possible Slack token found in env_template.sh"
            exit 1
          fi
          echo "OK: No API keys detected in template"

      - name: Check markdown links (basic)
        run: |
          echo "Checking for broken internal links..."
          # Find all markdown links to local files
          grep -hoE '\[.*\]\([^)]+\.md\)' *.md | while read -r link; do
            file=$(echo "$link" | sed 's/.*(\(.*\))/\1/' | cut -d'#' -f1)
            if [ ! -f "$file" ] && [ "$file" != "" ]; then
              echo "WARNING: Potentially broken link: $link -> $file"
            fi
          done

  # Test Claude Canvas (optional - only runs if submodule exists)
  test-canvas:
    name: Test Claude Canvas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check if claude-canvas exists
        id: check-canvas
        run: |
          if [ -d "claude-canvas/canvas" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "claude-canvas not found - skipping tests"
          fi

      - name: Setup Bun
        if: steps.check-canvas.outputs.exists == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check-canvas.outputs.exists == 'true'
        working-directory: claude-canvas/canvas
        run: bun install

      - name: Run tests
        if: steps.check-canvas.outputs.exists == 'true'
        working-directory: claude-canvas/canvas
        run: bun test

      - name: Type check
        if: steps.check-canvas.outputs.exists == 'true'
        working-directory: claude-canvas/canvas
        run: bunx tsc --noEmit

  # Validate shell scripts
  validate-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          echo "Linting shell scripts..."
          find . -name "*.sh" -type f | while read -r script; do
            echo "Checking: $script"
            shellcheck "$script" || true
          done

      - name: Check setup.sh is executable-ready
        run: |
          if [ -f "setup.sh" ]; then
            bash -n setup.sh
            echo "OK: setup.sh syntax is valid"
          fi

  # Test LLM CLI wrappers
  test-cli-wrappers:
    name: Test LLM CLI Wrappers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y jq shellcheck

      - name: Check CLI scripts exist and are executable
        run: |
          echo "Checking CLI wrapper scripts..."
          cli_scripts=(
            "scripts/llm-cli/gemini_cli"
            "scripts/llm-cli/openai_cli"
            "scripts/llm-cli/perplexity_cli"
            "scripts/llm-cli/ollama_cli"
            "scripts/llm-cli/setup.sh"
          )
          for script in "${cli_scripts[@]}"; do
            if [ ! -f "$script" ]; then
              echo "ERROR: Missing CLI script: $script"
              exit 1
            fi
            echo "✓ $script exists"
          done

      - name: Validate CLI script syntax
        run: |
          echo "Validating CLI script syntax..."
          for script in scripts/llm-cli/*; do
            if [ -f "$script" ]; then
              echo "Checking syntax: $script"
              bash -n "$script"
              echo "✓ $script syntax OK"
            fi
          done

      - name: Lint CLI scripts with shellcheck
        run: |
          echo "Linting CLI scripts..."
          for script in scripts/llm-cli/*; do
            if [ -f "$script" ] && [ "$script" != "scripts/llm-cli/setup.sh" ]; then
              echo "Shellcheck: $script"
              shellcheck -e SC2086,SC2181 "$script" || true
            fi
          done

      - name: Test CLI help commands
        run: |
          echo "Testing CLI help commands..."
          chmod +x scripts/llm-cli/*

          echo "--- gemini_cli --help ---"
          ./scripts/llm-cli/gemini_cli --help

          echo "--- openai_cli --help ---"
          ./scripts/llm-cli/openai_cli --help

          echo "--- perplexity_cli --help ---"
          ./scripts/llm-cli/perplexity_cli --help

          echo "--- ollama_cli --help ---"
          ./scripts/llm-cli/ollama_cli --help

          echo "✓ All help commands work"

      - name: Test CLI error handling (missing API keys)
        run: |
          echo "Testing error handling for missing API keys..."
          chmod +x scripts/llm-cli/*

          # gemini_cli should fail gracefully without API key
          if ./scripts/llm-cli/gemini_cli --task "test" 2>&1 | grep -q "GEMINI_API_KEY"; then
            echo "✓ gemini_cli correctly reports missing API key"
          else
            echo "ERROR: gemini_cli should report missing API key"
            exit 1
          fi

          # openai_cli should fail gracefully without API key
          if ./scripts/llm-cli/openai_cli --task "test" 2>&1 | grep -q "OPENAI_API_KEY"; then
            echo "✓ openai_cli correctly reports missing API key"
          else
            echo "ERROR: openai_cli should report missing API key"
            exit 1
          fi

          # perplexity_cli should fail gracefully without API key
          if ./scripts/llm-cli/perplexity_cli --query "test" 2>&1 | grep -q "PERPLEXITY_API_KEY"; then
            echo "✓ perplexity_cli correctly reports missing API key"
          else
            echo "ERROR: perplexity_cli should report missing API key"
            exit 1
          fi

      - name: Test setup.sh PATH configuration
        run: |
          echo "Testing setup.sh..."
          source scripts/llm-cli/setup.sh
          echo "✓ setup.sh loaded successfully"

  # Live API tests (only runs if secrets are configured)
  test-cli-live:
    name: Test CLI Live API Calls
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y jq

      - name: Test Gemini CLI (if configured)
        if: env.GEMINI_API_KEY != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          chmod +x scripts/llm-cli/gemini_cli
          echo "Testing Gemini CLI with live API..."
          response=$(./scripts/llm-cli/gemini_cli --model lite --task "Say 'CI test passed' and nothing else")
          echo "Response: $response"
          if echo "$response" | grep -iq "test\|passed\|ci"; then
            echo "✓ Gemini CLI live test passed"
          else
            echo "✓ Gemini CLI returned response (content may vary)"
          fi

      - name: Test Perplexity CLI (if configured)
        if: env.PERPLEXITY_API_KEY != ''
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          chmod +x scripts/llm-cli/perplexity_cli
          echo "Testing Perplexity CLI with live API..."
          response=$(./scripts/llm-cli/perplexity_cli --query "What is 2+2? One word answer.")
          echo "Response: $response"
          if [ -n "$response" ]; then
            echo "✓ Perplexity CLI live test passed"
          fi

      - name: Test OpenAI CLI (if configured)
        if: env.OPENAI_API_KEY != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          chmod +x scripts/llm-cli/openai_cli
          echo "Testing OpenAI CLI with live API..."
          response=$(./scripts/llm-cli/openai_cli --model gpt-4o-mini --task "Say 'CI test passed' and nothing else")
          echo "Response: $response"
          if [ -n "$response" ]; then
            echo "✓ OpenAI CLI live test passed"
          fi

  # Check JSON configuration files
  validate-json:
    name: Validate JSON Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" -type f | while read -r file; do
            echo "Checking: $file"
            python3 -m json.tool "$file" > /dev/null || {
              echo "ERROR: Invalid JSON in $file"
              exit 1
            }
          done
          echo "OK: All JSON files are valid"

  # Version consistency check
  version-check:
    name: Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check version consistency across docs
        run: |
          echo "Checking version consistency..."
          # Extract version from README.md
          readme_version=$(grep -oE 'Version:\*\* [0-9]+\.[0-9]+\.[0-9]+' README.md | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          claude_version=$(grep -oE 'Version:\*\* [0-9]+\.[0-9]+\.[0-9]+' CLAUDE.md | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          if [ "$readme_version" != "$claude_version" ]; then
            echo "WARNING: Version mismatch between README.md ($readme_version) and CLAUDE.md ($claude_version)"
          else
            echo "OK: Versions match: $readme_version"
          fi
